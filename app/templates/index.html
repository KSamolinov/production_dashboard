<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∞—à–±–æ—Ä–¥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f4f6f9;
      --card-bg: #fff;
      --text: #000;
      --muted: #555;
      --shadow: 0 2px 5px rgba(0,0,0,0.1);
      --radius: 10px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      color: var(--text);
    }
    header {
      background: #2c3e50;
      color: #fff;
      padding: 16px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    .container { padding: 20px; }

    /* –§–∏–ª—å—Ç—Ä—ã */
    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: end;
    }
    .filters label { font-size: 14px; color: #222; }
    .filters input,
    .filters select,
    .filters button {
      padding: 6px 8px;
      font-size: 14px;
    }
    .filters button {
      border: none;
      background: #2c3e50;
      color: #fff;
      border-radius: 6px;
      box-shadow: var(--shadow);
      cursor: pointer;
    }
    .filters button[disabled] { opacity: .6; cursor: not-allowed; }

    /* KPI */
    .kpi-container {
      display: flex;
      gap: 20px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }
    .kpi {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 15px;
      flex: 1;
      min-width: 200px;
      text-align: center;
    }
    .kpi h3 {
      margin: 0;
      font-size: 16px;
      color: #555;
      font-weight: 600;
    }
    .kpi p {
      margin: 6px 0 0;
      font-size: 22px;
      font-weight: bold;
      color: #000;
    }

    /* –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã */
    .charts {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .charts.row { flex-direction: row; }
    .chart {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 15px;
      box-shadow: var(--shadow);
      text-align: center;
      width: 100%;
    }
    .chart h3 { margin-top: 0; font-size: 16px; color: var(--muted); }
    .chart img {
      width: 100%;
      height: auto;
      border-radius: 6px;
    }
    .chart.pie { width: 50%; }
    .chart.table {
      width: 50%;
      overflow-x: auto;
    }
    .chart.table table {
      width: 100%;
      border-collapse: collapse;
    }
    .chart.table th, .chart.table td {
      padding: 6px 8px;
      border: 1px solid #ddd;
      text-align: left;
      white-space: nowrap;
    }
    .chart.bar-defects { margin-bottom: 20px; }

    /* –ê–¥–∞–ø—Ç–∏–≤ */
    @media (max-width: 900px) {
      .charts.row { flex-direction: column; }
      .chart.pie, .chart.table { width: 100%; }
    }
  </style>
</head>
<body>
<header>
  <h1>üìä –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∞—à–±–æ—Ä–¥</h1>
</header>

<div class="container">
  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="filters">
    <label>–ù–∞—á–∞–ª–æ:
      <input type="date" id="start" value="{{ start_iso }}" aria-label="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞">
    </label>
    <label>–ö–æ–Ω–µ—Ü:
      <input type="date" id="end" value="{{ end_iso }}" aria-label="–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞">
    </label>
    <label>–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞:
      <select id="nomenclature" aria-label="–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞">
        <option value="">–í—Å–µ</option>
      </select>
    </label>
    <label>–£—á–∞—Å—Ç–æ–∫:
      <select id="place" aria-label="–£—á–∞—Å—Ç–æ–∫">
        <option value="">–í—Å–µ</option>
      </select>
    </label>
    <button id="applyBtn" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
  </div>

  <!-- KPI -->
  <div class="kpi-container">
    <div class="kpi" role="status" aria-live="polite">
      <h3>–í—Å–µ–≥–æ –∫–∞—Ä—Ç</h3>
      <p id="total_cards">{{ total_cards }}</p>
    </div>
    <div class="kpi" role="status" aria-live="polite">
      <h3>–í—Å–µ–≥–æ –±—Ä–∞–∫–∞</h3>
      <p id="total_defects">{{ total_defects }}</p>
    </div>
    <div class="kpi" role="status" aria-live="polite">
      <h3>% –±—Ä–∞–∫–∞</h3>
      <p id="defect_percent">{{ defect_percent }} %</p>
    </div>
    <div class="kpi" role="status" aria-live="polite">
      <h3>–°—Ç–æ–∏–º–æ—Å—Ç—å –±—Ä–∞–∫–∞</h3>
      <p id="total_money">{{ total_money }}</p>
    </div>
  </div>

  <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
  <div class="charts">
    <div class="chart">
      <h3>–î–∏–Ω–∞–º–∏–∫–∞ –≤—ã–ø—É—Å–∫–∞</h3>
      <img id="line_total" src="/plots/line_total" alt="–ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ –≤—ã–ø—É—Å–∫–∞">
    </div>
    <div class="chart">
      <h3>–î–∏–Ω–∞–º–∏–∫–∞ –±—Ä–∞–∫–∞</h3>
      <img id="line_defects" src="/plots/line_defects" alt="–ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ –±—Ä–∞–∫–∞">
    </div>
    <div class="chart bar-defects">
      <h3>–ë—Ä–∞–∫ –ø–æ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞–º</h3>
      <img id="bar_defects" src="/plots/bar_defects" alt="–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –±—Ä–∞–∫–∞ –ø–æ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞–º">
    </div>
  </div>

  <!-- Pie + —Ç–∞–±–ª–∏—Ü–∞ -->
  <div class="charts row">
    <div class="chart pie">
      <h3>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±—Ä–∞–∫–∞</h3>
      <img id="pie_defects" src="/plots/pie_defects" alt="–ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±—Ä–∞–∫–∞">
    </div>
    <div class="chart table">
      <h3>–°—Ç–æ–∏–º–æ—Å—Ç—å –±—Ä–∞–∫–∞ –ø–æ –≤–∏–¥–∞–º</h3>
      <div id="defects_table">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>
</div>

<script>
  // ---------- –£—Ç–∏–ª–∏—Ç—ã ----------
  function escapeHTML(str) {
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function formatNumber(value, suffix = "") {
    const n = Number(value);
    return (Number.isFinite(n) ? n.toLocaleString("ru-RU") : "0") + suffix;
  }
  function setLoading(isLoading) {
    const btn = document.getElementById("applyBtn");
    btn.disabled = isLoading;
    btn.textContent = isLoading ? "–ü—Ä–∏–º–µ–Ω—è—é..." : "–ü—Ä–∏–º–µ–Ω–∏—Ç—å";
  }

  // ---------- KPI ----------
  function updateKPI(start, end, nomen = "", place = "") {
    let url = `/kpi?start=${start}&end=${end}`;
    if (nomen) url += `&nomen=${encodeURIComponent(nomen)}`;
    if (place) url += `&place=${encodeURIComponent(place)}`;

    return fetch(url)
      .then(resp => resp.json())
      .then(data => {
        document.getElementById("total_cards").innerText    = formatNumber(data.total_cards, " —à—Ç");
        document.getElementById("total_defects").innerText  = formatNumber(data.total_defects, " —à—Ç");
        const pct = Number(data.defect_percent);
        document.getElementById("defect_percent").innerText = (Number.isFinite(pct) ? pct.toFixed(2) : "0.00") + " %";
        document.getElementById("total_money").innerText    = formatNumber(data.total_money, " ‚ÇΩ");
      })
      .catch(err => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ KPI:", err);
      });
  }

  // ---------- –¢–∞–±–ª–∏—Ü–∞ ----------
  function updateDefectsTable(start, end, nomen = "", place = "") {
    let url = `/tables/defects?start=${start}&end=${end}`;
    if (nomen) url += `&nomen=${encodeURIComponent(nomen)}`;
    if (place) url += `&place=${encodeURIComponent(place)}`;

    const box = document.getElementById("defects_table");
    box.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";

    return fetch(url)
      .then(resp => resp.json())
      .then(rows => {
        if (!Array.isArray(rows) || rows.length === 0) {
          box.innerHTML = "<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>";
          return;
        }
        let html = "<table><thead><tr><th>–í–∏–¥ –±—Ä–∞–∫–∞</th><th>–°—É–º–º–∞, ‚ÇΩ</th></tr></thead><tbody>";
        for (const row of rows) {
          if (row.sum === null) {
            html += `<tr><td colspan="2" style="text-align:center; font-style:italic; color:#888;">
                       ${escapeHTML(row.defect)}
                     </td></tr>`;
          } else {
            html += `<tr>
              <td>${escapeHTML(row.defect)}</td>
              <td>${formatNumber(row.sum)} ‚ÇΩ</td>
            </tr>`;
          }
        }
        html += "</tbody></table>";
        box.innerHTML = html;
      })
      .catch(err => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–∞–±–ª–∏—Ü—ã:", err);
        box.innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>";
      });
  }

  // ---------- –ì—Ä–∞—Ñ–∏–∫–∏ ----------
  function refreshCharts(start, end, nomen = "", place = "") {
    // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–ø—É—Ç–∞–ª –¥–∞—Ç—ã ‚Äî –ø–æ–º–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏
    let s = start, e = end;
    if (s && e && s > e) [s, e] = [e, s];

    const qs = new URLSearchParams({
      start: s,
      end: e,
      ...(nomen ? { nomen } : {}),
      ...(place ? { place } : {}),
      cb: Date.now().toString(), // –∫—ç—à-–±–∞—Å—Ç–µ—Ä
    }).toString();

    document.getElementById("line_total").src   = `/plots/line_total?${qs}`;
    document.getElementById("line_defects").src = `/plots/line_defects?${qs}`;
    document.getElementById("bar_defects").src  = `/plots/bar_defects?${qs}`;
    document.getElementById("pie_defects").src  = `/plots/pie_defects?${qs}`;
  }

  // ---------- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ ----------
  function applyFilters() {
    const start = document.getElementById("start").value;
    const end   = document.getElementById("end").value;
    const nomen = document.getElementById("nomenclature").value;
    const place = document.getElementById("place").value;

    setLoading(true);
    Promise.all([
      updateKPI(start, end, nomen, place),
      updateDefectsTable(start, end, nomen, place),
    ]).finally(() => {
      refreshCharts(start, end, nomen, place);
      setLoading(false);
    });
  }

  // ---------- –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ ----------
  function hydrateSelect(id, items) {
    const select = document.getElementById(id);
    if (!Array.isArray(items)) return;
    for (const item of items) {
      const opt = document.createElement("option");
      opt.value = item;
      opt.textContent = item;
      select.appendChild(opt);
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
  Promise.all([
    fetch("/nomenclature").then(r => r.json()).then(data => hydrateSelect("nomenclature", data)).catch(() => {}),
    fetch("/places").then(r => r.json()).then(data => hydrateSelect("place", data)).catch(() => {}),
  ]).finally(() => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –ø—Ä–∏—à–µ–¥—à–∏–º–∏ —Å –±—ç–∫–∞
    const start = document.getElementById("start").value;
    const end   = document.getElementById("end").value;
    updateKPI(start, end);
    updateDefectsTable(start, end);
    refreshCharts(start, end);
  });
</script>
</body>
</html>
